<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº¢çŸ³å·¥åŠ Â· æ–°æ˜¥çƒŸèŠ±å¸ˆ</title>
    <style>
        :root {
            --mc-bg: #C6C6C6;
            --mc-dark: #373737;
            --mc-light: #FFFFFF;
            --mc-slot: #8B8B8B;
            --festival-red: #D32F2F;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            /* ä¿®æ”¹è¦æ±‚ 1: å…¨éƒ¨å­—ä½“ä½¿ç”¨å¾®è½¯é›…é»‘ */
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif; 
            font-weight: bold;
            color: white;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 850px;
            background: url('/res/spr/bg_village_night.jpg') no-repeat center center;
            background-size: cover;
            position: relative;
            overflow: hidden;
            border: 4px solid var(--mc-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* é€šç”¨ UI ç»„ä»¶ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10;
        }

        .active { display: flex; }

        .mc-btn {
            background-color: var(--mc-bg);
            border-top: 4px solid var(--mc-light);
            border-left: 4px solid var(--mc-light);
            border-right: 4px solid var(--mc-dark);
            border-bottom: 4px solid var(--mc-dark);
            color: #222;
            padding: 15px 20px;
            font-family: inherit;
            font-size: 16px; /* å­—ä½“æ”¹åŠ¨åç¨å¾®è°ƒå¤§å­—å· */
            cursor: pointer;
            margin-top: 20px;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
        }
        .mc-btn:active {
            border-top: 4px solid var(--mc-dark);
            border-left: 4px solid var(--mc-dark);
            border-right: 4px solid var(--mc-light);
            border-bottom: 4px solid var(--mc-light);
        }

        .dialog-box {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--festival-red);
            padding: 20px;
            margin: 20px;
            line-height: 1.6;
            font-size: 14px;
            border-radius: 8px; /* å¾®è½¯é›…é»‘é£æ ¼ä¸‹å¯ä»¥ç¨å¾®åœ†æ¶¦ä¸€ç‚¹ */
        }

        /* é˜¶æ®µ 2: æ”¶é›† */
        #collect-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }
        #timer {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--festival-red);
            font-size: 24px;
            z-index: 6;
            text-shadow: 2px 2px 0 #fff;
        }

        /* é˜¶æ®µ 3: åˆæˆå° */
        .crafting-ui {
            background: #C6C6C6;
            padding: 10px;
            border: 4px solid #373737;
            color: #222;
            width: 90%;
        }

        .grid-3x3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin: 10px auto;
            width: 160px;
        }

        .slot {
            width: 48px;
            height: 48px;
            background-color: #8B8B8B;
            border: 2px solid #373737;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        
        .slot.selected { border-color: var(--festival-red); }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .item-icon {
            width: 32px;
            height: 32px;
            display: block;
        }

        /* æ¨¡æ‹Ÿç‰©å“å›¾æ ‡ CSS */
        .icon-gunpowder { background: #555; border-radius: 50%; box-shadow: 2px 2px 0 #222; }
        .icon-paper { background: #fff; border: 1px solid #ccc; transform: rotate(10deg); }
        .icon-gold { background: #FFD700; border: 2px solid #B8860B; }
        .icon-enderpearl { background: #008080; border-radius: 50%; box-shadow: inset 2px 2px 5px #fff; }
        .icon-dye { background: var(--festival-red); border-radius: 50%; }
        .icon-star { background: #E0FFFF; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }

        /* é˜¶æ®µ 4: ç»“æœ */
        #firework-canvas { position: absolute; top:0; left:0; z-index: 1; }
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 25px;
            border: 4px solid var(--festival-red);
            z-index: 20;
            width: 80%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .chinese-knot { color: var(--festival-red); font-size: 24px; margin-bottom: 10px; }
        
        /* å…‘æ¢ç æ ·å¼ */
        .redeem-section {
            background: #eee;
            border: 2px dashed #999;
            padding: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .redeem-code {
            font-size: 20px;
            color: var(--festival-red);
            font-weight: 900;
            letter-spacing: 2px;
            user-select: text; /* å…è®¸ç”¨æˆ·å¤åˆ¶ */
        }
        .redeem-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>

<div id="game-container">
    <audio id="audio-explode" src="/res/spr/explode.mp3" preload="auto"></audio>
    
    <div id="screen-intro" class="screen active">
        <div style="font-size:40px; margin-bottom:20px;">ğŸ§¨</div>
        <h1>çº¢çŸ³å·¥åŠ</h1>
        <div class="dialog-box">
            <p style="color:yellow; font-weight:bold;">æ‘æ°‘ï¼š</p>
            <p>â€œæ–°æ˜¥åˆ°äº†ï¼æˆ‘éœ€è¦ä½ åˆ¶ä½œæœ€ç‰¹åˆ«çš„çƒŸèŠ±ï¼â€</p>
            <p>â€œå¿«å»æ”¶é›†ç«è¯å’Œç¥ç§˜ææ–™å§ï¼â€</p>
        </div>
        <button class="mc-btn" onclick="startGame()">æ¥å—ä»»åŠ¡</button>
    </div>

    <div id="screen-collect" class="screen">
        <div id="timer">10</div>
        <canvas id="collect-canvas"></canvas>
        <div class="dialog-box" style="position: absolute; bottom: 20px;">
            <p>ç‚¹å‡»æ‰è½çš„æ–¹å—æ”¶é›†ææ–™ï¼</p>
        </div>
    </div>

    <div id="screen-craft" class="screen">
        <h3 style="margin-top: 10px; color:#333;">åˆæˆçƒŸèŠ±</h3>
        <div class="crafting-ui">
            <div style="text-align: left; font-size: 12px; margin-bottom: 5px;">åˆæˆåŒº (3x3)</div>
            <div class="grid-3x3" id="craft-grid">
                <div class="slot" data-index="0" onclick="placeItem(0)"></div>
                <div class="slot" data-index="1" onclick="placeItem(1)"></div>
                <div class="slot" data-index="2" onclick="placeItem(2)"></div>
                <div class="slot" data-index="3" onclick="placeItem(3)"></div>
                <div class="slot" data-index="4" onclick="placeItem(4)"></div>
                <div class="slot" data-index="5" onclick="placeItem(5)"></div>
                <div class="slot" data-index="6" onclick="placeItem(6)"></div>
                <div class="slot" data-index="7" onclick="placeItem(7)"></div>
                <div class="slot" data-index="8" onclick="placeItem(8)"></div>
            </div>
            
            <div style="text-align: left; font-size: 12px; margin: 10px 0 5px;">èƒŒåŒ… (ç‚¹å‡»é€‰ä¸­)</div>
            <div class="inventory" id="inventory-display">
                </div>
            
            <button class="mc-btn" style="width:100%" onclick="craftFireworks()">åˆæˆ !</button>
            <button class="mc-btn" style="width:100%; margin-top:5px; font-size:12px" onclick="clearGrid()">æ¸…ç©º</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <canvas id="firework-canvas"></canvas>
        <div class="result-card" id="result-text" style="display:none;">
            <div class="chinese-knot">â™¦ æ­å–œå‘è´¢ â™¦</div>
            <h2 id="firework-name">æ™®é€šçƒŸèŠ±</h2>
            <p id="blessing-text">çˆ†ç«¹å£°ä¸­ä¸€å²é™¤</p>
            
            <div class="redeem-section">
                <div class="redeem-label">æ‚¨çš„æ–°æ˜¥ç¤¼åŒ…å…‘æ¢ç </div>
                <div id="redeem-code-display" class="redeem-code">LOADING...</div>
            </div>

            <hr style="border:1px dashed #ccc; margin: 15px 0;">
            <p style="font-size:12px; color:#555;">2026 è¿åŠ¿å…³é”®è¯</p>
            <h3 id="fortune-word" style="color:var(--festival-red); font-size:24px;">çº¢çŸ³å¤§æ‹¿</h3>
            <button class="mc-btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>
</div>

<script>
    // --- æ¸¸æˆæ•°æ® ---
    // ä½¿ç”¨ /res/spr/ ç›®å½•ä¸‹çš„çœŸå®åƒç´ å›¾ç‰‡èµ„æº
    const items = [
        { id: 'gunpowder', name: 'ç«è¯', class: 'icon-gunpowder', color: '#555', img: '/res/spr/gunpowder.png' },
        { id: 'paper', name: 'çº¸', class: 'icon-paper', color: '#fff', img: '/res/spr/paper.png' },
        { id: 'gold', name: 'é‡‘é”­', class: 'icon-gold', color: '#FFD700', img: '/res/spr/gold_ingot.png' },
        { id: 'enderpearl', name: 'æœ«å½±çç ', class: 'icon-enderpearl', color: '#008080', img: '/res/spr/ender_pearl.png' },
        { id: 'dye', name: 'çº¢æŸ“æ–™', class: 'icon-dye', color: '#D32F2F', img: '/res/spr/red_dye.png' },
        { id: 'star', name: 'ä¸‹ç•Œä¹‹æ˜Ÿ', class: 'icon-star', color: '#E0FFFF', img: '/res/spr/nether_star.png' }
    ];

    let inventory = {};
    let craftGrid = Array(9).fill(null);
    let selectedItem = null;
    let canvas, ctx, animationId;

    // --- æµç¨‹æ§åˆ¶ ---
    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- é˜¶æ®µ 2: æ”¶é›†å°æ¸¸æˆé€»è¾‘ ---
    let fallingItems = [];
    let gameTimer = 10;
    let timerInt = null;
    let spawnInt = null;
    
    // é¢„åŠ è½½å›¾ç‰‡èµ„æº
    const preloadedImages = {};
    items.forEach(item => {
        const img = new Image();
        img.src = item.img;
        preloadedImages[item.id] = img;
    });

    function startGame() {
        if (timerInt) clearInterval(timerInt);
        if (spawnInt) clearInterval(spawnInt);
        if (animationId) cancelAnimationFrame(animationId);
        
        switchScreen('screen-collect');
        canvas = document.getElementById('collect-canvas');
        ctx = canvas.getContext('2d');
        
        // å¼ºåˆ¶é‡ç½®ç”»å¸ƒå¤§å°ï¼Œé˜²æ­¢å°ºå¯¸å¼‚å¸¸
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width || window.innerWidth;
        canvas.height = rect.height || window.innerHeight;

        gameTimer = 10;
        fallingItems = [];
        items.forEach(i => inventory[i.id] = 0);
        inventory['gunpowder'] = 1; 
        inventory['paper'] = 1;
        document.getElementById('timer').innerText = gameTimer;

        // ç”Ÿæˆé¢‘ç‡ï¼šæ¯ 400ms æ‰è½ä¸€ä¸ª
        spawnInt = setInterval(() => {
            if(gameTimer > 0) spawnItem();
        }, 400);

        timerInt = setInterval(() => {
            gameTimer--;
            document.getElementById('timer').innerText = gameTimer;
            if (gameTimer <= 0) endCollectStage();
        }, 1000);

        function renderLoop() {
            // ä¸¥æ ¼æ£€æŸ¥å½“å‰ç•Œé¢ï¼Œé˜²æ­¢åå°è¿è¡Œ
            if (!document.getElementById('screen-collect').classList.contains('active')) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = fallingItems.length - 1; i >= 0; i--) {
                const item = fallingItems[i];
                item.y += item.speed;
                
                const img = preloadedImages[item.data.id];
                // ä¿®å¤ï¼šå¿…é¡»ç¡®ä¿å›¾ç‰‡åŠ è½½æˆåŠŸ(naturalWidth > 0)æ‰ç»˜åˆ¶å›¾ç‰‡ï¼Œå¦åˆ™ç»˜åˆ¶æ–¹å—
                // è¿™è§£å†³äº†å›¾ç‰‡ 404 å¯¼è‡´ç‰©å“é€æ˜æ¶ˆå¤±çš„é—®é¢˜
                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.drawImage(img, item.x, item.y, 45, 45);
                } else {
                    ctx.fillStyle = item.data.color;
                    ctx.fillRect(item.x, item.y, 40, 40);
                    // ç»˜åˆ¶ç®€æ˜“è¾¹æ¡†ï¼Œè®©æ–¹å—æ›´å¥½çœ‹
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(item.x, item.y, 40, 40);
                }

                if (item.y > canvas.height) fallingItems.splice(i, 1);
            }
            animationId = requestAnimationFrame(renderLoop);
        }
        animationId = requestAnimationFrame(renderLoop);

        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå¤„ç†åæ ‡
        canvas.onclick = (e) => handleInput(e.clientX, e.clientY);
        canvas.ontouchstart = (e) => {
            if(e.cancelable) e.preventDefault();
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        };
    }

    function handleInput(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        for (let i = fallingItems.length - 1; i >= 0; i--) {
            const item = fallingItems[i];
            // åˆ¤å®šèŒƒå›´æ¯”æ˜¾ç¤ºèŒƒå›´ç¨å¤§ï¼Œæ–¹ä¾¿ç‚¹å‡»
            if (x >= item.x - 10 && x <= item.x + 55 && y >= item.y - 10 && y <= item.y + 55) {
                inventory[item.data.id]++;
                createClickEffect(item.x, item.y);
                fallingItems.splice(i, 1);
                break; 
            }
        }
    }

    function spawnItem() {
        const rand = Math.random() * 100;
        let itemData;
        
        // æ¦‚ç‡åˆ†é…
        if (rand < 12) itemData = items[5];      // ä¸‹ç•Œä¹‹æ˜Ÿ
        else if (rand < 28) itemData = items[3]; // æœ«å½±çç 
        else if (rand < 48) itemData = items[2]; // é‡‘é”­
        else if (rand < 68) itemData = items[4]; // çº¢æŸ“æ–™
        else if (rand < 84) itemData = items[0]; // ç«è¯
        else itemData = items[1];                // çº¸

        fallingItems.push({
            x: 10 + Math.random() * (canvas.width - 60),
            y: -50,
            speed: 3.5 + Math.random() * 4.5,
            data: itemData
        });
    }

    function handleCollectClick(e) {
        if (e.cancelable) e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        for (let i = fallingItems.length - 1; i >= 0; i--) {
            const item = fallingItems[i];
            // æ‰©å¤§ç‚¹å‡»åˆ¤å®šèŒƒå›´ï¼Œæ”¹å–„æ‰‹æ„Ÿ
            if (x >= item.x - 10 && x <= item.x + 55 && y >= item.y - 10 && y <= item.y + 55) {
                inventory[item.data.id]++;
                createClickEffect(item.x, item.y);
                fallingItems.splice(i, 1);
                break; 
            }
        }
    }

    function endCollectStage() {
        clearInterval(timerInt);
        clearInterval(spawnInt);
        cancelAnimationFrame(animationId);
        canvas.removeEventListener('mousedown', handleCollectClick);
        canvas.removeEventListener('touchstart', handleCollectClick);
        goToCrafting();
    }

    function createClickEffect(x, y) {
        const el = document.createElement('div');
        el.innerText = "+1";
        el.style.position = 'absolute';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.color = '#fff';
        el.style.fontSize = '20px';
        el.style.fontWeight = 'bold';
        el.style.transition = 'all 0.5s';
        document.getElementById('game-container').appendChild(el);
        setTimeout(() => {
            el.style.top = (y - 50) + 'px';
            el.style.opacity = 0;
        }, 10);
        setTimeout(() => el.remove(), 500);
    }

    function resizeCanvas(c) {
        c.width = c.parentElement.offsetWidth;
        c.height = c.parentElement.offsetHeight;
    }

    // --- é˜¶æ®µ 3: åˆæˆé€»è¾‘ ---
    function goToCrafting() {
        switchScreen('screen-craft');
        renderInventory();
    }

    function renderInventory() {
        const container = document.getElementById('inventory-display');
        container.innerHTML = '';
        items.forEach(item => {
            if (inventory[item.id] > 0) {
                const div = document.createElement('div');
                div.className = 'slot';
                div.onclick = () => selectInventoryItem(item.id, div);
                div.innerHTML = `
                    <img src="${item.img}" class="item-icon" alt="${item.name}">
                    <span style="position:absolute; bottom:0; right:2px; font-size:10px; font-weight:bold;">${inventory[item.id]}</span>
                `;
                container.appendChild(div);
            }
        });
    }

    function selectInventoryItem(id, element) {
        document.querySelectorAll('.inventory .slot').forEach(el => el.style.borderColor = '#373737');
        element.style.borderColor = 'white';
        selectedItem = id;
    }

    function placeItem(index) {
        if (!selectedItem) return;
        if (inventory[selectedItem] > 0) {
            if (craftGrid[index]) {
                inventory[craftGrid[index]]++;
            }
            craftGrid[index] = selectedItem;
            inventory[selectedItem]--;
            renderInventory();
            renderGrid();
        }
    }

    function renderGrid() {
        const slots = document.getElementById('craft-grid').children;
        for (let i = 0; i < 9; i++) {
            slots[i].innerHTML = '';
            if (craftGrid[i]) {
                const item = items.find(it => it.id === craftGrid[i]);
                slots[i].innerHTML = `<img src="${item.img}" class="item-icon" alt="${item.name}">`;
            }
        }
    }
    
    function clearGrid() {
        for(let i=0; i<9; i++) {
            if(craftGrid[i]) {
                inventory[craftGrid[i]]++;
                craftGrid[i] = null;
            }
        }
        renderInventory();
        renderGrid();
    }

    // --- æ ¸å¿ƒï¼šåˆæˆé…æ–¹æ£€æµ‹ ---
    function craftFireworks() {
        const counts = {};
        craftGrid.forEach(id => {
            if (id) counts[id] = (counts[id] || 0) + 1;
        });

        if (!counts['gunpowder'] || !counts['paper']) {
            alert("é…æ–¹é”™è¯¯ï¼šä½ éœ€è¦è‡³å°‘ 1 ä¸ªç«è¯å’Œ 1 å¼ çº¸ï¼");
            return;
        }

        let result = {
            name: "æ™®é€šå°çƒŸèŠ±",
            msg: "å¹³å¹³å®‰å®‰ï¼Œé¡ºé¡ºåˆ©åˆ©",
            fortune: "æ‘åº„æ–°äºº",
            color: "#FFFFFF",
            type: "normal",
            code: "2026-PEACE" // å¯¹åº”å…‘æ¢ç åç¼€
        };

        if (counts['star']) {
            result = { name: "åƒç´ å·¨é¾™ Â· ä¼ è¯´", msg: "é£é¾™åœ¨å¤©ï¼Œä¸‡äº‹å¦‚æ„ï¼", fortune: "æ¬§æ°”çˆ†æ£š", color: "rainbow", type: "dragon", code: "DRAGON-888" };
        } else if (counts['enderpearl']) {
            result = { name: "è™šç©ºä¹‹çœ¼ Â· å²è¯—", msg: "é¾™è¡Œå¤©ä¸‹ï¼Œå‰ç¨‹ä¼¼é”¦", fortune: "æœ«åœ°è¡Œè€…", color: "#008080", type: "pearl", code: "ENDER-LUCK" };
        } else if (counts['gold']) {
            result = { name: "è´¢æºæ»šæ»š Â· ç¨€æœ‰", msg: "é‡‘æ˜Ÿæº…å°„ï¼Œè´¢è¿äº¨é€š", fortune: "å¤šè´¢å¤šäº¿", color: "#FFD700", type: "gold", code: "GOLD-RICH" };
        } else if (counts['dye']) {
            result = { name: "çº¢çº¢ç«ç«", msg: "å¤§çº¢ç¯ç¬¼é«˜é«˜æŒ‚", fortune: "é¸¿è¿å½“å¤´", color: "#D32F2F", type: "red", code: "RED-LUCKY" };
        }

        launchFireworks(result);
    }

    // --- é˜¶æ®µ 4: çƒŸèŠ±å±•ç¤º ---
    function launchFireworks(resultData) {
        switchScreen('screen-result');
        const fCanvas = document.getElementById('firework-canvas');
        const fCtx = fCanvas.getContext('2d');
        resizeCanvas(fCanvas);

        document.getElementById('firework-name').innerText = resultData.name;
        document.getElementById('blessing-text').innerText = resultData.msg;
        document.getElementById('fortune-word').innerText = resultData.fortune;
        
        // ç”Ÿæˆæœ€ç»ˆå…‘æ¢ç ï¼šBL(Bloret Launcher) + å¹´ä»½ + ç±»å‹ä»£ç 
        const finalCode = `BL26-${resultData.code}`;
        document.getElementById('redeem-code-display').innerText = finalCode;

        let particles = [];
        
        function createExplosion() {
            const centerX = fCanvas.width / 2;
            const centerY = fCanvas.height / 3;
            const particleCount = resultData.type === 'dragon' ? 300 : 100;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                let color = resultData.color;
                
                if (color === 'rainbow') {
                    const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
                    color = colors[Math.floor(Math.random() * colors.length)];
                }

                particles.push({
                    x: centerX,
                    y: centerY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1,
                    color: color,
                    decay: Math.random() * 0.02 + 0.01
                });
            }
        }

        createExplosion();
        
        // æ’­æ”¾çƒŸèŠ±çˆ†ç‚¸éŸ³æ•ˆ
        const explodeAudio = document.getElementById('audio-explode');
        if (explodeAudio) {
            explodeAudio.currentTime = 0; // é‡ç½®è¿›åº¦ä»¥ä¾¿å¿«é€Ÿè¿ç»­æ’­æ”¾
            explodeAudio.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾"));
        }

        function animate() {
            fCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            fCtx.fillRect(0, 0, fCanvas.width, fCanvas.height);

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.05; 
                p.alpha -= p.decay;

                fCtx.beginPath();
                fCtx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                fCtx.fillStyle = p.color;
                fCtx.globalAlpha = p.alpha;
                fCtx.fill();

                if (p.alpha <= 0) particles.splice(i, 1);
            }
            fCtx.globalAlpha = 1;

            if (particles.length > 0) {
                requestAnimationFrame(animate);
            } else {
                setTimeout(() => {
                    document.getElementById('result-text').style.display = 'block';
                }, 500);
            }
        }
        animate();
    }
</script>
</body>
</html>